<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NZ Trip V40 (Activity & Hollow Stamp)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts: Zen Maru Gothic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, enableIndexedDbPersistence, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWCdRmB3l8PDg6O_tzX2pT2-50ajpdXEw",
            authDomain: "mynztrip-4955d.firebaseapp.com",
            projectId: "mynztrip-4955d",
            storageBucket: "mynztrip-4955d.firebasestorage.app",
            messagingSenderId: "733993847062",
            appId: "1:733993847062:web:15246edf39b8d5002b6837",
            measurementId: "G-7HBWQ93Y43"
        };

        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            window.firestoreDB = db;
            window.firebaseAuth = auth;
            window.firestoreMethods = { doc, onSnapshot, setDoc, deleteDoc, signInAnonymously, onAuthStateChanged };
        } catch (e) {
            console.warn("Firebase config missing. Running in local mode.");
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: 'rgb(var(--c-primary) / <alpha-value>)', dark: 'rgb(var(--c-primary-dark) / <alpha-value>)', light: 'rgb(var(--c-primary-light) / <alpha-value>)' },
                        cream: { DEFAULT: 'rgb(var(--c-cream) / <alpha-value>)', dark: 'rgb(var(--c-cream-dark) / <alpha-value>)', darker: 'rgb(var(--c-cream-darker) / <alpha-value>)' },
                        yellow: { card: 'rgb(var(--c-card-bg) / <alpha-value>)', text: 'rgb(var(--c-card-text) / <alpha-value>)' },
                        dark: { DEFAULT: 'rgb(var(--c-dark) / <alpha-value>)', soft: 'rgb(var(--c-dark-soft) / <alpha-value>)' },
                        accent: 'rgb(var(--c-accent) / <alpha-value>)',
                    },
                    fontFamily: { sans: ['Zen Maru Gothic', 'sans-serif'] },
                    boxShadow: { 
                        'soft': '0 4px 20px -5px rgba(var(--c-primary), 0.1)',
                        'sticker': '2px 3px 0px rgba(0,0,0,0.08)',
                        'float': '0 10px 30px -10px rgba(var(--c-primary), 0.2)'
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            /* Default: Oat Milk Beige */
            --c-primary: 211 198 184; 
            --c-primary-dark: 166 153 140; 
            --c-primary-light: 235 228 220; 
            --c-cream: 253 251 248; 
            --c-cream-dark: 242 238 232;
            --c-cream-darker: 226 219 210;
            --c-card-bg: 255 255 255; 
            --c-card-text: 93 86 80; 
            --c-dark: 93 86 80; 
            --c-dark-soft: 120 112 105;
            --c-accent: 211 198 184;
        }
        body { 
            -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; 
            background-color: rgb(var(--c-cream)); 
            /* Improved Dot Grid Texture */
            background-image: radial-gradient(rgb(var(--c-primary-dark)) 0.5px, transparent 0.5px);
            background-size: 24px 24px;
            background-position: 0 0;
            opacity: 1; color: rgb(var(--c-dark)); transition: background-color 0.5s, color 0.5s; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        
        .timeline-line { position: absolute; left: 23px; top: 3.5rem; bottom: -1rem; width: 0px; border-left: 2px dashed rgb(var(--c-primary-light)); opacity: 0.6; z-index: 0; }
        .dot-marker { width: 10px; height: 10px; border-radius: 50%; background: rgb(var(--c-cream)); border: 2px solid rgb(var(--c-primary)); position: relative; z-index: 1; }
        .input-rounded { border-radius: 12px; border: 1px solid rgb(var(--c-cream-darker)); transition: all 0.2s; }
        .input-rounded:focus { border-color: rgb(var(--c-primary)); box-shadow: 0 0 0 3px rgba(var(--c-primary), 0.15); }
        
        /* Map Styles */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin { width: 34px; height: 34px; border-radius: 50% 50% 50% 0; background: rgb(var(--c-primary)); position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -15px 0 0 -15px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; }
        .marker-pin::after { content: ''; width: 20px; height: 20px; margin: 0; background: #fff; position: absolute; border-radius: 50%; }
        .marker-text { position: absolute; bottom: -8px; left: -25px; width: 70px; text-align: center; font-size: 10px; font-weight: 700; color: rgb(var(--c-dark)); background: rgba(255,255,255,0.95); border-radius: 8px; padding: 2px 4px; pointer-events: none; border: 1px solid rgb(var(--c-cream-darker)); box-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .modal-scroll { overscroll-behavior: contain; }

        /* HANDWRITTEN & WASHI TAPE STYLES */
        .hand-drawn-box {
            border: 1px solid rgba(var(--c-dark), 0.08); /* Thinner border for MUJI look */
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 2px 3px 0px rgba(var(--c-dark), 0.05); /* Softer shadow */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background: white;
            transform-origin: center;
        }
        .hand-drawn-box:hover { transform: scale(1.01) rotate(0.2deg); box-shadow: 4px 5px 0px rgba(var(--c-dark), 0.08); }
        .hand-drawn-box:active { transform: scale(0.99); box-shadow: 1px 2px 0px rgba(var(--c-dark), 0.05); }

        .washi-tape {
            position: absolute; top: -6px; left: 50%;
            width: 80px; height: 18px;
            background-color: rgba(var(--c-primary-light), 0.4);
            opacity: 0.9; z-index: 20;
            mask-image: linear-gradient(90deg, transparent 2px, black 2px, black calc(100% - 2px), transparent calc(100% - 2px));
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            mix-blend-mode: multiply;
        }

        .tape-pattern-dots { background-image: radial-gradient(rgba(255,255,255,0.6) 30%, transparent 30%); background-size: 6px 6px; }
        .tape-pattern-stripes { background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.4) 0, rgba(255,255,255,0.4) 3px, transparent 3px, transparent 8px); }
        .tape-pattern-grid { background-image: linear-gradient(rgba(255,255,255,0.4) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.4) 1px, transparent 1px); background-size: 8px 8px; }

        /* Hollow Stamp Effect */
        .stamp-mark {
            position: absolute; z-index: 5; opacity: 0.8; mix-blend-mode: multiply; pointer-events: none;
            animation: stamp-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        /* Make icon hollow using text-stroke and transparent color */
        .stamp-mark i {
            color: transparent;
            -webkit-text-stroke: 1.5px rgba(220, 38, 38, 0.65); /* Reddish stroke */
        }
        @keyframes stamp-pop { 0% { transform: scale(1.5) rotate(0deg); opacity: 0; } 100% { transform: scale(1) rotate(var(--r)); opacity: 0.8; } }

        .notebook-lines {
            background-image: linear-gradient(transparent 95%, rgba(var(--c-primary), 0.15) 95%);
            background-size: 100% 1.6rem;
            line-height: 1.6rem;
            padding-top: 0.2rem;
        }
        
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; box-shadow: 3px 4px 0px rgba(0,0,0,0.2); border: 2px solid white; }
        .leaflet-popup-content { margin: 0; font-family: 'Zen Maru Gothic', sans-serif !important; }
        .polaroid-popup { padding: 8px; text-align: center; background: #fff; }
        .polaroid-title { font-weight: 800; color: #333; font-size: 14px; margin-bottom: 2px; }
        .polaroid-desc { font-size: 10px; color: #666; }
        .leaflet-popup-tip { background: white; box-shadow: 3px 3px 0px rgba(0,0,0,0.05); }

    </style>
</head>
<body class="text-dark h-[100dvh] w-screen flex flex-col overflow-hidden selection:bg-primary-light selection:text-dark-soft">
    <div id="app" class="h-full flex flex-col relative">
        <input type="file" ref="saveFileInput" @change="loadFromFile" accept=".json" class="hidden">
        
        <!-- Header -->
        <header class="bg-cream/90 backdrop-blur-sm pt-safe-top px-6 pb-2 shrink-0 z-30 flex justify-between items-end transition-colors duration-300">
            <div class="h-10 pb-1 flex flex-col justify-end">
                <h1 class="text-xl font-bold tracking-tight text-primary font-sans flex items-center gap-2" style="text-shadow: 1px 1px 0px rgba(255,255,255,0.8);">
                    <i class="fa-solid fa-mountain-sun text-primary"></i>
                    NZ Trip <span class="text-[10px] bg-primary/10 px-1.5 rounded text-primary/70 font-bold mt-1">V40 Èè§Á©∫Áâà</span>
                    <span v-if="connectionStatus === 'cloud'" class="text-[9px] bg-green-100/80 text-green-700 px-2 py-0.5 rounded-full font-bold animate-pulse font-mono tracking-wider border border-green-200"><i class="fa-solid fa-cloud"></i> {{ tripId }}</span>
                    <span v-else-if="connectionStatus === 'connecting'" class="text-[9px] bg-yellow-100/80 text-yellow-700 px-2 py-0.5 rounded-full font-bold animate-pulse border border-yellow-200"><i class="fa-solid fa-circle-notch fa-spin"></i> {{ loadingMessage }}</span>
                    <span v-else @click="showErrorDetail" class="text-[9px] bg-red-100/80 text-red-500 px-2 py-0.5 rounded-full font-bold cursor-pointer hover:bg-red-200 active:scale-95 transition-all border border-red-200"><i class="fa-solid fa-circle-exclamation"></i> OFFLINE</span>
                </h1>
            </div>
            <div class="flex gap-2">
                <div v-if="hasPendingUploads" class="w-9 h-9 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center animate-bounce border border-orange-200 shadow-sm" title="ÊúâÊú™‰∏äÂÇ≥ÁöÑËÆäÊõ¥"><i class="fa-solid fa-arrow-up-from-bracket text-xs"></i></div>
                <button @click="showSettingsModal = true" class="w-10 h-10 rounded-full bg-white/80 border-2 border-primary/20 shadow-sm flex items-center justify-center text-primary/70 hover:text-primary transition-colors active:scale-90 hover:border-primary/50 relative"><i class="fa-solid fa-sliders text-sm"></i><div class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-400 rounded-full border-2 border-white"></div></button>
            </div>
        </header>

        <!-- Main -->
        <main class="flex-1 overflow-hidden relative">
            
            <!-- 1. ITINERARY TAB -->
            <div v-if="currentTab === 'itinerary'" class="h-full flex flex-col">
                <div class="pt-1 pb-2 shrink-0 z-20 bg-cream/80 backdrop-blur-sm relative border-b border-cream-darker/30">
                    <div ref="dateContainer" class="flex overflow-x-auto no-scrollbar px-4 space-x-2 scroll-smooth py-1">
                        <button v-for="(date, index) in days" :key="index" @click="selectDate(index)" class="flex-shrink-0 flex flex-col items-center justify-center w-[3.5rem] h-[4rem] transition-all duration-300 relative group active:scale-95" :class="selectedDayIndex === index ? 'z-10' : 'opacity-70 hover:opacity-100'">
                             <div class="absolute inset-0 border-2 bg-white transition-colors duration-300" :class="selectedDayIndex === index ? 'bg-white border-primary rotate-[-2deg] shadow-sticker' : 'border-transparent bg-white/50 hover:border-cream-darker'" style="border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;"></div>
                             <div v-if="selectedDayIndex === index" class="absolute -top-1.5 w-8 h-3 bg-primary/30 rotate-2" style="mask-image: radial-gradient(circle at 2px, transparent 2px, black 2.5px); mask-position: -2px;"></div>
                             <div class="relative z-10 flex flex-col items-center" :class="selectedDayIndex === index ? 'text-primary' : 'text-gray-500'">
                                <span class="text-[9px] font-bold tracking-wide uppercase">Day</span>
                                <span class="text-xl font-black font-sans -my-1">{{ index }}</span>
                                <span class="text-[9px] font-bold">{{ date.getMonth()+1 }}/{{ date.getDate() }}</span>
                             </div>
                        </button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto pb-32" id="itinerary-scroll-container">
                    <div class="px-4 pt-4 pb-2">
                        <!-- Day Header Card -->
                        <div class="bg-primary text-white p-4 relative overflow-hidden group transition-all duration-300" style="border-radius: 15px 255px 15px 255px / 255px 15px 225px 15px; box-shadow: 3px 4px 0px rgba(0,0,0,0.15);">
                             <div class="washi-tape tape-pattern-stripes" style="background-color: rgba(255,255,255,0.3); top:-5px; transform: translateX(-50%) rotate(2deg);"></div>
                            <div class="flex justify-between items-start relative z-10">
                                <div class="flex-1 min-w-0 mr-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="bg-white/20 text-white px-2 py-0.5 rounded-lg text-[10px] font-bold tracking-wider backdrop-blur-sm shrink-0 border border-white/20">D{{ selectedDayIndex }} ¬∑ {{ getWeekDay(days[selectedDayIndex]) }}</span>
                                        <div class="flex gap-2 overflow-x-auto no-scrollbar">
                                            <span v-for="(w, idx) in dailyWeatherList" :key="idx" class="text-[10px] font-bold flex items-center gap-1 text-white bg-white/10 px-2 py-0.5 rounded-full whitespace-nowrap backdrop-blur-sm cursor-help shrink-0 border border-white/20" :title="`üìç Âú∞Èªû: ${w.name} (${w.lat}, ${w.lng})`"><i :class="w.icon"></i><span class="opacity-90 max-w-[80px] truncate">{{ w.name }}</span><span>{{ w.temp }}¬∞</span></span>
                                        </div>
                                    </div>
                                    <h2 class="text-xl font-bold text-white flex items-start gap-2 leading-snug min-w-0" style="text-shadow: 1px 1px 0 rgba(0,0,0,0.1);"><span class="flex-1 min-w-0 break-words">{{ getDaySummary }}</span><button @click.stop="openDaySettings" class="text-white/60 hover:text-white text-xs transition-colors active:scale-90 shrink-0 mt-1"><i class="fa-solid fa-pen"></i></button></h2>
                                </div>
                                <div @click="toggleGlobalFold" class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center cursor-pointer hover:bg-white/30 transition-colors text-white mt-0.5 active:scale-90 shrink-0 border border-white/20"><i class="fa-solid text-xs transition-transform duration-300" :class="isAllExpanded ? 'fa-compress' : 'fa-expand'"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="px-4 pt-2">
                        <div v-if="filteredItinerary.length === 0" class="flex flex-col items-center justify-center h-32 text-gray-400 border-2 border-dashed border-primary/20 rounded-2xl m-2 bg-white/30">
                            <i class="fa-regular fa-calendar-plus text-2xl mb-1 text-primary/30"></i>
                            <p class="font-bold text-[10px] text-primary/50">ÈªûÊìäÂè≥‰∏ãËßíÊñ∞Â¢ûË°åÁ®ã</p>
                        </div>
                        <div v-for="(item, index) in filteredItinerary" :key="item.id" class="group mb-4 relative pl-3">
                            <div v-if="index !== filteredItinerary.length - 1" class="timeline-line"></div>
                            
                            <div class="hand-drawn-box relative flex flex-col z-10 overflow-hidden" :style="getCardRotation(index)">
                                <div class="washi-tape" :class="getWashiTapeClass(item)" :style="getWashiTapeStyle(item)"></div>
                                
                                <!-- Updated Stamp to be Hollow -->
                                <div v-if="item.stamp" class="stamp-mark" :style="getStampStyle(item)">
                                    <i :class="['fa-solid', item.stamp]" class="text-4xl"></i>
                                </div>

                                <div class="p-3 flex gap-3 items-start relative z-10" @click="toggleItem(item.id)">
                                    <div class="flex flex-col items-center min-w-[3rem] shrink-0 pt-0.5">
                                        <span class="text-sm font-black text-dark/80 font-sans tracking-tight">{{ item.time }}</span>
                                        <div class="dot-marker mt-2 shadow-sm"></div>
                                    </div>
                                    <div class="flex-1 min-w-0 pt-0">
                                        <div class="flex justify-between items-start">
                                            <h3 class="font-bold text-dark text-lg leading-tight truncate pr-1 select-text relative inline-block">
                                                {{ item.title || item.location }}
                                                <span class="absolute bottom-0.5 left-0 w-full h-[6px] bg-primary/20 -z-10 rounded-full"></span>
                                            </h3>
                                            <div class="flex items-center gap-2 shrink-0">
                                                <button @click.stop="navigateTo(item.address || item.location)" class="w-7 h-7 rounded-full bg-cream text-primary border border-cream-darker flex items-center justify-center hover:bg-primary hover:text-white transition-colors active:scale-90 shadow-sm"><i class="fa-solid fa-location-arrow text-[10px]"></i></button>
                                                <button @click.stop="toggleItem(item.id)" class="w-7 h-7 rounded-full bg-cream text-gray-400 border border-cream-darker flex items-center justify-center hover:bg-primary hover:text-white transition-colors active:scale-90 shadow-sm"><i class="fa-solid fa-chevron-down text-[10px] transition-transform duration-300" :class="{'rotate-180': expandedItems.has(item.id)}"></i></button>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 mt-1.5 flex-wrap">
                                            <span class="text-[10px] px-2 py-0.5 rounded-sm font-bold tracking-wide border-b-2" :class="getTypeColorClass(item.type)">{{ item.type }}</span>
                                            <span v-if="item.location && item.location !== item.title" class="text-[11px] text-gray-500 flex items-center gap-1 font-medium"><i class="fa-solid fa-location-dot text-primary/60 text-[9px]"></i> {{ item.location }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div v-show="expandedItems.has(item.id)" class="px-4 pb-4 pt-0 relative z-10">
                                    <div class="mt-2 space-y-3 pt-3 border-t-2 border-dashed border-gray-100">
                                        <div v-if="item.notes" class="relative group/note">
                                            <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-4 h-8 border-2 border-gray-300 rounded-full z-20 pointer-events-none opacity-50"></div>
                                            <div class="p-3 bg-yellow-50/50 rounded-lg text-sm text-gray-700 leading-relaxed whitespace-pre-wrap relative select-text notebook-lines font-medium shadow-sm transform rotate-[0.5deg]" style="font-family: 'Zen Maru Gothic', sans-serif;">{{ item.notes }}</div>
                                        </div>
                                        
                                        <div v-if="item.subItems && item.subItems.length > 0">
                                            <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 pl-1 flex items-center gap-2"><span class="w-1 h-1 rounded-full bg-gray-300"></span>Â≠êË°åÁ®ã</h4>
                                            <div class="space-y-2">
                                                <div v-for="(sub, sIdx) in item.subItems" :key="sIdx" class="bg-white p-2.5 rounded-lg border border-gray-200 shadow-sm flex justify-between items-center hover:border-primary/30 transition-colors">
                                                    <div class="flex items-center gap-2 overflow-hidden">
                                                        <i class="fa-regular fa-circle text-[8px] text-primary/50 shrink-0"></i>
                                                        <div class="min-w-0">
                                                            <div class="text-sm font-bold text-dark truncate">{{ sub.location }}</div>
                                                            <div v-if="sub.notes" class="text-[10px] text-gray-400 truncate">{{ sub.notes }}</div>
                                                        </div>
                                                    </div>
                                                    <button @click.stop="navigateTo(sub.location)" class="w-7 h-7 rounded-full bg-gray-50 text-gray-400 border border-gray-100 flex items-center justify-center hover:bg-primary hover:text-white transition-colors active:scale-90"><i class="fa-solid fa-location-arrow text-[10px]"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 mt-2 pt-2 justify-end">
                                            <button @click.stop="editItem(item)" class="w-8 h-8 bg-white border border-gray-200 text-gray-400 rounded-lg hover:text-dark hover:border-dark transition-colors flex items-center justify-center shadow-sm active:scale-90"><i class="fa-solid fa-pen text-xs"></i></button>
                                            <button @click.stop="copyItem(item)" class="w-8 h-8 bg-white border border-gray-200 text-gray-400 rounded-lg hover:text-primary hover:border-primary transition-colors flex items-center justify-center shadow-sm active:scale-90"><i class="fa-regular fa-copy text-xs"></i></button>
                                            <button @click.stop="deleteItem(item.id)" class="w-8 h-8 bg-white border border-gray-200 text-gray-400 rounded-lg hover:text-red-400 hover:border-red-400 transition-colors flex items-center justify-center shadow-sm active:scale-90"><i class="fa-regular fa-trash-can text-xs"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openModal('itinerary')" class="fixed bottom-6 right-5 w-14 h-14 bg-dark text-white rounded-full shadow-lg flex items-center justify-center text-xl hover:scale-105 transition-transform z-30 border-4 border-white/80 active:scale-90"><i class="fa-solid fa-plus"></i></button>
            </div>

            <!-- 2. EXPENSES TAB -->
            <div v-if="currentTab === 'expenses'" class="h-full flex flex-col bg-cream rounded-t-[2.5rem] mt-2 shadow-inner overflow-hidden border-t border-cream-dark transition-colors duration-300">
                <div class="p-5 bg-yellow-card m-3 mb-1 shadow-sticker relative overflow-hidden transition-colors duration-300" style="border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;">
                    <div class="washi-tape tape-pattern-dots" style="top: -8px; background-color: rgba(255,255,255,0.4);"></div>
                    <div class="flex justify-between items-start mb-2"><p class="text-[10px] font-bold text-yellow-text/70 uppercase tracking-widest">Á∏ΩÊîØÂá∫ (‰º∞ÁÆó)</p><button @click="showStatsModal = true" class="bg-white/50 text-yellow-text hover:bg-white px-2 py-0.5 rounded-lg text-[10px] font-bold transition-colors flex items-center gap-1 active:scale-95"><i class="fa-solid fa-chart-pie"></i></button></div>
                    <div class="flex flex-col mb-3"><div class="flex items-baseline gap-2"><span class="text-sm font-bold text-yellow-text">NZD</span><span class="text-4xl font-black text-yellow-text font-sans tracking-tight">{{ grandTotalNZD.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) }}</span></div><div class="text-xs font-bold text-yellow-text/70 mt-0.5 border-t border-yellow-text/20 pt-1 inline-block">‚âà NT$ {{ Math.round(grandTotalTWD).toLocaleString() }}</div></div>
                    <div class="flex gap-2"><div class="flex-1 bg-white/40 px-3 py-2 rounded-xl text-yellow-text font-bold flex flex-col items-start"><span class="text-[9px] opacity-60 uppercase">NZD ÁèæÈáë/Âà∑Âç°</span><span class="text-base font-sans">${{ totalNZD.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) }}</span></div><div class="flex-1 bg-white/40 px-3 py-2 rounded-xl text-yellow-text font-bold flex flex-col items-start"><span class="text-[9px] opacity-60 uppercase">TWD Âà∑Âç°/Â∑≤‰ªò</span><span class="text-base font-sans">${{ totalTWD.toLocaleString() }}</span></div></div>
                </div>
                <div class="flex-1 overflow-y-auto px-4 pb-28 pt-2">
                    <div v-for="(group, date) in groupedExpenses" :key="date" class="mb-5">
                        <div class="flex items-center justify-between mb-2 px-1 border-b border-dashed border-primary/20 pb-1">
                            <span class="text-[11px] font-bold text-primary bg-primary/10 px-2 py-0.5 rounded-full">{{ date }}</span>
                            <span class="text-[11px] font-bold text-dark">Â∞èË®à: ${{ group.total.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) }}</span>
                        </div>
                        <div v-for="expense in group.items" :key="expense.id" class="bg-white rounded-xl p-3 mb-2 border-2 border-transparent hover:border-primary/20 transition-all flex justify-between items-center group relative shadow-card active:scale-[0.995]">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <div class="w-10 h-10 rounded-full bg-cream flex items-center justify-center text-sm shrink-0 text-gray-500 border border-cream-dark transition-colors duration-300"><i :class="getCategoryIcon(expense.category)"></i></div>
                                <div class="min-w-0">
                                    <div class="flex items-center gap-2"><h4 class="font-bold text-dark text-sm truncate">{{ expense.item }}</h4></div>
                                    <div class="flex gap-1 mt-0.5">
                                        <span class="text-[9px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">{{ expense.payer }}</span>
                                        <span class="text-[9px] border border-gray-100 text-gray-400 px-1.5 py-0.5 rounded">{{ expense.category }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right shrink-0">
                                <div class="font-bold text-dark text-sm">{{ expense.currency }} {{ expense.originalAmount }}</div>
                                <div class="text-[10px] text-gray-400">‚âà NT$ {{ Math.round(expense.baseAmount * exchangeRate) }}</div>
                            </div>
                            <button @click="deleteExpense(expense.id)" class="absolute -right-2 -top-2 bg-white text-red-400 w-6 h-6 rounded-full shadow-md border border-gray-100 items-center justify-center hidden group-hover:flex hover:bg-red-50 active:scale-90"><i class="fa-solid fa-xmark text-[10px]"></i></button>
                        </div>
                    </div>
                </div>
                <button @click="openModal('expense')" class="fixed bottom-6 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-lg flex items-center justify-center text-xl z-30 border-4 border-white/80 active:scale-90"><i class="fa-solid fa-pen"></i></button>
            </div>

            <!-- 3. MAP TAB -->
            <div v-if="currentTab === 'map'" class="h-full w-full relative">
                <div id="map-container" class="h-full w-full bg-gray-100"></div>
                <div class="absolute top-4 left-4 right-4 z-[400] flex justify-between pointer-events-none"><div class="bg-white/90 backdrop-blur px-3 py-1.5 rounded-xl shadow-sticker pointer-events-auto border-2 border-white"><p class="text-xs font-bold text-gray-600">Day {{ selectedDayIndex }}</p></div><button @click="locateUser" class="bg-white/90 backdrop-blur w-9 h-9 rounded-xl shadow-sticker flex items-center justify-center text-primary pointer-events-auto border-2 border-white active:scale-95 transition-transform"><i class="fa-solid fa-crosshairs"></i></button></div>
            </div>

            <!-- 4. CALCULATOR TAB -->
            <div v-if="currentTab === 'calculator'" class="h-full flex flex-col p-6 bg-cream">
                <div class="bg-white p-6 shadow-sticker flex-1 flex flex-col relative" style="border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;">
                    <div class="washi-tape tape-pattern-grid"></div>
                    <h2 class="text-xl font-bold text-dark mb-6 text-center">ÂåØÁéáË®àÁÆóÊ©ü</h2>
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 relative">
                            <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Á¥êÂπ£ (NZD)</label>
                            <input type="number" v-model="calcNZD" class="w-full bg-transparent text-4xl font-bold text-dark outline-none" placeholder="0">
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl opacity-20 font-bold">$</span>
                        </div>
                        <div class="flex justify-center items-center text-gray-300"><i class="fa-solid fa-arrow-down-up"></i></div>
                        <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 relative">
                            <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Âè∞Âπ£ (TWD)</label>
                            <input type="number" v-model="calcTWD" class="w-full bg-transparent text-4xl font-bold text-primary outline-none" placeholder="0">
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl opacity-20 font-bold">NT</span>
                        </div>
                    </div>
                    <div class="mt-8 grid grid-cols-4 gap-3">
                        <button v-for="n in [1,5,10,50]" @click="addNZD(n)" class="py-3 bg-white border-2 border-cream-dark rounded-xl text-sm font-bold text-dark hover:border-primary hover:text-primary transition-colors shadow-sm active:scale-95">+{{n}}</button>
                        <button @click="calcNZD=0; calcTWD=0" class="col-span-4 py-3 bg-gray-100 text-gray-400 rounded-xl text-xs font-bold hover:bg-red-50 hover:text-red-400 transition-colors mt-2">Ê∏ÖÈô§ (Clear)</button>
                    </div>
                    <div class="mt-auto text-center text-xs text-gray-400 pt-4">ÂåØÁéá: 1 NZD ‚âà {{ exchangeRate }} TWD</div>
                </div>
            </div>

            <!-- 5. TODO TAB -->
            <div v-if="currentTab === 'todo'" class="h-full flex flex-col bg-cream pt-2">
                <div class="px-4 pb-2 shrink-0">
                    <div class="flex bg-white p-1 rounded-2xl shadow-sticker border border-cream-darker">
                        <button v-for="cat in ['Ë°åÂâçÊ∫ñÂÇô', 'Ë°åÊùéÊ∏ÖÂñÆ', 'Ë≥ºÁâ©Ê∏ÖÂñÆ']" @click="todoCategory = cat" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all" :class="todoCategory === cat ? 'bg-primary text-white shadow-sm' : 'text-gray-400 hover:text-gray-600'">{{ cat }}</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto px-4 pb-28">
                    <div class="bg-white p-5 shadow-sticker border border-cream-darker min-h-[300px] relative mt-2" style="border-radius: 5px 25px 5px 25px;">
                         <div class="washi-tape" style="background-color: rgba(var(--c-accent), 0.3);"></div>
                         <div class="flex gap-2 mb-4 items-start relative z-10">
                             <textarea v-model="newTodoText" rows="1" placeholder="Êñ∞Â¢ûÂæÖËæ¶ (ÂèØÊèõË°å)..." class="flex-1 bg-gray-50 rounded-xl px-3 py-3 text-sm outline-none border border-transparent focus:border-primary resize-none"></textarea>
                             <button @click="addTodo" class="w-10 h-10 bg-dark text-white rounded-xl flex items-center justify-center active:scale-95 shadow-sm shrink-0 mt-1"><i class="fa-solid fa-plus"></i></button>
                         </div>
                         <div class="space-y-2 relative z-10">
                             <div v-for="todo in filteredTodos" :key="todo.id" class="p-3 rounded-xl transition-colors notebook-lines" :class="todo.done ? 'bg-gray-50/50' : 'bg-white border-b border-gray-100'">
                                 <div v-if="editingTodoId === todo.id" class="flex gap-2 items-start">
                                     <textarea v-model="tempTodoText" rows="2" class="flex-1 bg-white border border-primary/50 rounded-lg px-2 py-1 text-sm outline-none resize-none focus:ring-2 focus:ring-primary/20"></textarea>
                                     <div class="flex flex-col gap-1 shrink-0">
                                          <button @click="saveEditTodo(todo)" class="w-8 h-8 bg-primary text-white rounded-lg flex items-center justify-center shadow-sm"><i class="fa-solid fa-check text-xs"></i></button>
                                          <button @click="cancelEditTodo" class="w-8 h-8 bg-gray-100 text-gray-400 rounded-lg flex items-center justify-center"><i class="fa-solid fa-xmark text-xs"></i></button>
                                     </div>
                                 </div>
                                 <div v-else class="flex items-start justify-between">
                                     <div class="flex items-start gap-3 flex-1 cursor-pointer" @click="toggleTodo(todo)">
                                         <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all duration-300 mt-0.5 shrink-0" :class="todo.done ? 'bg-green-500 border-green-500 text-white scale-110' : 'border-gray-300 text-transparent'"><i class="fa-solid fa-check text-[10px]" :class="{'scale-0': !todo.done, 'scale-100': todo.done}"></i></div>
                                         <span class="text-sm font-bold transition-all whitespace-pre-wrap break-words leading-snug font-hand" :class="todo.done ? 'text-gray-400 line-through opacity-60 blur-[0.3px]' : 'text-dark'">{{ todo.text }}</span>
                                     </div>
                                     <div class="flex gap-1 shrink-0 ml-2 mt-0.5">
                                         <button @click.stop="startEditTodo(todo)" class="w-6 h-6 flex items-center justify-center text-gray-300 hover:text-primary"><i class="fa-solid fa-pen text-xs"></i></button>
                                         <button @click.stop="deleteTodo(todo.id)" class="w-6 h-6 flex items-center justify-center text-gray-300 hover:text-red-400"><i class="fa-solid fa-xmark text-sm"></i></button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Navigation -->
        <nav class="fixed bottom-5 left-1/2 transform -translate-x-1/2 w-[calc(100%-3rem)] max-w-[20rem] h-16 bg-white/90 backdrop-blur-md shadow-2xl border-2 border-white/50 flex justify-between items-center px-4 z-[9999] transition-all duration-300" style="border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;">
            <button @click="currentTab = 'itinerary'" class="w-12 h-12 flex flex-col items-center justify-center rounded-full transition-all duration-300 active:scale-90 gap-0.5" :class="currentTab === 'itinerary' ? 'text-primary' : 'text-gray-400 hover:text-gray-600'"><i class="fa-solid fa-book-open text-xl mb-0.5"></i><span class="text-[9px] font-bold">Ë°åÁ®ã</span></button>
            <button @click="currentTab = 'expenses'" class="w-12 h-12 flex flex-col items-center justify-center rounded-full transition-all duration-300 active:scale-90 gap-0.5" :class="currentTab === 'expenses' ? 'text-primary' : 'text-gray-400 hover:text-gray-600'"><i class="fa-solid fa-wallet text-xl mb-0.5"></i><span class="text-[9px] font-bold">Ë®òÂ∏≥</span></button>
            <button @click="currentTab = 'map'" class="w-12 h-12 flex flex-col items-center justify-center rounded-full transition-all duration-300 active:scale-90 gap-0.5" :class="currentTab === 'map' ? 'text-primary' : 'text-gray-400 hover:text-gray-600'"><i class="fa-regular fa-map text-xl mb-0.5"></i><span class="text-[9px] font-bold">Âú∞Âúñ</span></button>
            <button @click="currentTab = 'calculator'" class="w-12 h-12 flex flex-col items-center justify-center rounded-full transition-all duration-300 active:scale-90 gap-0.5" :class="currentTab === 'calculator' ? 'text-primary' : 'text-gray-400 hover:text-gray-600'"><i class="fa-solid fa-calculator text-xl mb-0.5"></i><span class="text-[9px] font-bold">ÊèõÁÆó</span></button>
            <button @click="currentTab = 'todo'" class="w-12 h-12 flex flex-col items-center justify-center rounded-full transition-all duration-300 active:scale-90 gap-0.5" :class="currentTab === 'todo' ? 'text-primary' : 'text-gray-400 hover:text-gray-600'"><i class="fa-solid fa-list-check text-xl mb-0.5"></i><span class="text-[9px] font-bold">Ê∏ÖÂñÆ</span></button>
        </nav>

        <!-- Itinerary Modal -->
        <transition name="slide-up">
            <div v-if="showItineraryModal" class="fixed inset-0 z-[10000] flex items-end justify-center sm:items-center">
                <div class="absolute inset-0 bg-dark/20 backdrop-blur-[2px]" @click="closeModal"></div>
                <div class="bg-cream w-full sm:w-96 p-6 shadow-2xl relative z-10 max-h-[90vh] overflow-y-auto modal-scroll pb-10" style="border-radius: 25px 25px 0 0;">
                    <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4 opacity-50"></div>
                    <h3 class="text-xl font-bold text-dark mb-6 text-center">{{ isEditing ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-5 gap-3">
                            <div class="col-span-2"><label class="text-[10px] font-bold text-gray-400 mb-0.5 block pl-2">DAY</label><select v-model="form.dayIndex" class="w-full bg-white input-rounded p-2.5 text-sm font-bold text-center appearance-none outline-none"><option v-for="(d, i) in days" :value="i">Day {{ i }}</option></select></div>
                            <div class="col-span-3"><label class="text-[10px] font-bold text-gray-400 mb-0.5 block pl-2">TIME</label><div class="flex gap-2"><select v-model="formHour" class="flex-1 bg-white input-rounded p-2.5 text-sm font-bold text-center appearance-none outline-none"><option v-for="h in 24" :value="(h-1).toString().padStart(2,'0')">{{ (h-1).toString().padStart(2,'0') }}</option></select><span class="self-center font-bold text-gray-300">:</span><select v-model="formMinute" class="flex-1 bg-white input-rounded p-2.5 text-sm font-bold text-center appearance-none outline-none"><option v-for="m in 60" :value="(m-1).toString().padStart(2,'0')">{{ (m-1).toString().padStart(2,'0') }}</option></select></div></div>
                        </div>
                        <div><label class="text-[10px] font-bold text-gray-400 mb-0.5 block pl-2">TITLE</label><input type="text" v-model="form.title" placeholder="‰æãÂ¶ÇÔºöÂâçÂæÄÈ§êÂª≥ÂêÉÊôöÈ§ê" class="w-full bg-white input-rounded p-3 text-sm font-bold outline-none"></div>
                        <div class="bg-white p-2.5 rounded-2xl border border-dashed border-gray-200">
                             <div class="flex justify-between items-center mb-1 px-1"><label class="text-[10px] font-bold text-gray-400">LOCATION</label><span v-if="form.lat" class="text-[9px] text-green-500 font-mono"><i class="fa-solid fa-check"></i> {{ form.lat.toFixed(3) }},{{ form.lng.toFixed(3) }}</span></div>
                             <div class="flex gap-2"><input type="text" v-model="form.location" placeholder="Âú∞ÈªûÂêçÁ®±" class="flex-1 bg-gray-50 rounded-xl p-2 text-sm font-bold outline-none"><button @click="searchCoord(form)" :disabled="isSearchingCoord" class="w-9 h-9 rounded-xl bg-gray-100 text-gray-400 hover:bg-primary hover:text-white transition-colors flex items-center justify-center shrink-0 active:scale-90"><i class="fa-solid" :class="isSearchingCoord ? 'fa-circle-notch fa-spin' : 'fa-magnifying-glass'"></i></button></div>
                             <div class="flex gap-2 mt-2">
                                <input type="number" step="any" v-model.number="form.lat" placeholder="Lat" class="w-1/2 bg-gray-50 rounded-lg p-1.5 text-[9px] text-center outline-none border border-transparent focus:border-primary">
                                <input type="number" step="any" v-model.number="form.lng" placeholder="Lng" class="w-1/2 bg-gray-50 rounded-lg p-1.5 text-[9px] text-center outline-none border border-transparent focus:border-primary">
                             </div>
                        </div>
                        <div class="bg-white p-2.5 rounded-2xl border border-dashed border-gray-200">
                            <label class="text-[10px] font-bold text-gray-400 mb-1 block pl-1">MOOD STAMP (ÂøÉÊÉÖÂç∞Á´†)</label>
                            <div class="flex gap-2 overflow-x-auto no-scrollbar py-1">
                                <button v-for="icon in stamps" :key="icon" @click="form.stamp === icon ? form.stamp = null : form.stamp = icon" class="w-10 h-10 rounded-xl border-2 flex items-center justify-center text-xl transition-all active:scale-90 shrink-0" :class="form.stamp === icon ? 'border-red-400 bg-red-50 text-red-500 shadow-sm' : 'border-gray-100 text-gray-300 hover:border-gray-200'"><i :class="['fa-solid', icon]"></i></button>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1 px-1"><label class="text-[10px] font-bold text-gray-400">SUB-ITEMS</label><button @click="addSubItem" class="text-[9px] bg-primary/10 text-primary px-2 py-0.5 rounded-lg font-bold hover:bg-primary hover:text-white transition-colors active:scale-95"><i class="fa-solid fa-plus mr-1"></i>Êñ∞Â¢û</button></div>
                            <div class="space-y-2">
                                <div v-for="(sub, idx) in form.subItems" :key="idx" class="bg-white p-2.5 rounded-xl border border-cream-dark relative">
                                    <button @click="removeSubItem(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400 active:scale-90"><i class="fa-solid fa-xmark text-xs"></i></button>
                                    <div class="flex gap-2 mb-1.5 pr-6">
                                        <input type="text" v-model="sub.location" placeholder="Â≠êÂú∞Èªû" class="flex-1 text-xs font-bold outline-none bg-transparent border-b border-gray-100 focus:border-primary pb-0.5">
                                        <button @click="searchCoord(sub)" :disabled="isSearchingCoord" class="text-gray-300 hover:text-primary active:scale-90"><i class="fa-solid fa-magnifying-glass text-xs"></i></button>
                                    </div>
                                    <input type="number" step="any" v-model.number="sub.lat" placeholder="Lat" class="w-1/2 bg-gray-50 rounded-lg p-1 text-[9px] text-center outline-none hidden">
                                    <input type="number" step="any" v-model.number="sub.lng" placeholder="Lng" class="w-1/2 bg-gray-50 rounded-lg p-1 text-[9px] text-center outline-none hidden">
                                    <input type="text" v-model="sub.notes" placeholder="ÂÇôË®ª..." class="w-full text-xs text-gray-500 bg-transparent outline-none">
                                </div>
                            </div>
                        </div>
                        <div><label class="text-[10px] font-bold text-gray-400 mb-0.5 block pl-2">CATEGORY</label><div class="flex flex-wrap gap-2"><button v-for="t in ['ÊôØÈªû','ÁæéÈ£ü','‰ΩèÂÆø','‰∫§ÈÄö','Ë≥ºÁâ©','Ê¥ªÂãï','ÂÖ∂‰ªñ']" @click="form.type = t" class="px-3 py-1.5 rounded-lg text-[10px] font-bold border transition-all active:scale-95" :class="form.type === t ? 'bg-dark text-white border-dark' : 'bg-white text-gray-400 border-gray-100 hover:border-gray-300'">{{ t }}</button></div></div>
                        <div><label class="text-[10px] font-bold text-gray-400 mb-0.5 block pl-2">MEMO</label><textarea v-model="form.notes" rows="3" class="w-full bg-white input-rounded p-3 text-sm outline-none resize-none notebook-lines"></textarea></div>
                    </div>
                    <button @click="saveItinerary" class="w-full py-3.5 bg-primary text-white rounded-2xl font-bold mt-5 shadow-lg shadow-primary/20 active:scale-[0.98] transition-transform">ÂÑ≤Â≠òË°åÁ®ã</button>
                </div>
            </div>
        </transition>

        <!-- ... other modals ... -->
        <transition name="slide-up">
            <div v-if="showExpenseModal" class="fixed inset-0 z-[10000] flex items-end justify-center sm:items-center">
                <div class="absolute inset-0 bg-dark/30 backdrop-blur-sm" @click="closeModal"></div>
                <div class="bg-[#FDFBF7] w-full sm:w-[400px] rounded-t-3xl p-6 shadow-2xl relative z-10">
                    <button @click="closeModal" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-400 hover:bg-gray-200 active:scale-90"><i class="fa-solid fa-xmark"></i></button>
                    <h3 class="text-lg font-bold text-dark mb-5 pl-1">Êñ∞Â¢ûÊîØÂá∫</h3>
                    <div class="space-y-4">
                        <div><label class="text-[10px] font-bold text-gray-400 mb-1 block pl-2">È†ÖÁõÆÂêçÁ®±</label><input type="text" v-model="expenseForm.item" placeholder="‰æãÂ¶ÇÔºöÂçàÈ§ê" class="w-full bg-white h-12 rounded-xl px-4 text-sm font-bold text-dark shadow-sm border border-transparent focus:border-primary outline-none"></div>
                        <div class="bg-white p-2 rounded-xl shadow-sm border border-gray-50"><div class="flex bg-gray-50 rounded-lg p-1 mb-2"><button @click="expenseForm.currency = 'NZD'" class="flex-1 py-1.5 rounded-md text-xs font-bold transition-all active:scale-95" :class="expenseForm.currency === 'NZD' ? 'bg-white text-primary shadow-sm' : 'text-gray-400'">NZD $</button><button @click="expenseForm.currency = 'TWD'" class="flex-1 py-1.5 rounded-md text-xs font-bold transition-all active:scale-95" :class="expenseForm.currency === 'TWD' ? 'bg-white text-primary shadow-sm' : 'text-gray-400'">TWD $</button></div><div class="px-2 pb-1 relative"><input type="number" v-model.number="expenseForm.amount" placeholder="0" class="w-full text-2xl font-bold text-dark bg-transparent outline-none placeholder-gray-200 pl-1"></div></div>
                        <div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-gray-400 mb-1 block pl-2">ÂàÜÈ°û</label><div class="relative"><select v-model="expenseForm.category" class="w-full bg-white h-10 rounded-xl pl-3 pr-8 text-xs font-bold text-dark appearance-none shadow-sm border border-transparent outline-none"><option v-for="c in expenseCategories" :value="c">{{ c }}</option></select><i class="fa-solid fa-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 text-xs"></i></div></div><div><label class="text-[10px] font-bold text-gray-400 mb-1 block pl-2">‰ªòÊ¨æ‰∫∫</label><div class="relative"><select v-model="expenseForm.payer" class="w-full bg-white h-10 rounded-xl pl-3 pr-8 text-xs font-bold text-dark appearance-none shadow-sm border border-transparent outline-none"><option v-for="p in payers" :value="p">{{ p }}</option></select><i class="fa-solid fa-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 text-xs"></i></div></div></div>
                        <div><label class="text-[10px] font-bold text-gray-400 mb-1 block pl-2">Êó•Êúü</label><div class="relative"><input type="date" v-model="expenseForm.date" class="w-full bg-white h-10 rounded-xl px-3 text-xs font-bold text-gray-600 appearance-none shadow-sm border border-transparent outline-none"><i class="fa-regular fa-calendar absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 pointer-events-none text-xs"></i></div></div>
                    </div>
                    <button @click="saveExpense" class="w-full py-3.5 bg-dark text-white rounded-xl font-bold mt-6 shadow-lg shadow-dark/20 active:scale-[0.98] transition-transform">ÂÑ≤Â≠òÁ¥ÄÈåÑ</button>
                </div>
            </div>
        </transition>

        <div v-if="showStatsModal" class="fixed inset-0 z-[10000] flex items-center justify-center bg-dark/30 backdrop-blur-sm p-4">
            <div class="bg-cream w-full sm:w-[400px] rounded-3xl p-6 shadow-2xl relative max-h-[85vh] overflow-y-auto modal-scroll">
                <button @click="showStatsModal=false" class="absolute top-4 right-4 text-gray-400 hover:text-dark transition-colors active:scale-90"><i class="fa-solid fa-xmark text-lg"></i></button>
                <h3 class="text-lg font-bold text-dark mb-4 flex items-center gap-2"><span class="bg-yellow-card p-1 rounded-lg text-yellow-text"><i class="fa-solid fa-chart-pie"></i></span>Ê∂àË≤ªÁµ±Ë®à</h3>
                <div class="mb-4"><h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 pl-1">‰æù‰ªòÊ¨æ‰∫∫ (By Payer)</h4><div class="space-y-2"><div v-for="payer in payers" :key="payer" class="bg-white p-3 rounded-xl shadow-card border border-cream-dark flex justify-between items-center"><div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-primary/10 text-primary flex items-center justify-center text-[10px] font-bold">{{ payer.charAt(0) }}</div><span class="font-bold text-dark text-xs">{{ payer }}</span></div><div class="text-right flex flex-col gap-0.5"><span v-if="expenseStats.payers[payer].NZD > 0" class="text-[10px] font-bold text-dark bg-gray-50 px-1.5 py-0.5 rounded">NZD {{ expenseStats.payers[payer].NZD.toLocaleString() }}</span><span v-if="expenseStats.payers[payer].TWD > 0" class="text-[10px] font-bold text-gray-500 bg-gray-50 px-1.5 py-0.5 rounded">TWD {{ expenseStats.payers[payer].TWD.toLocaleString() }}</span><span v-if="expenseStats.payers[payer].NZD === 0 && expenseStats.payers[payer].TWD === 0" class="text-[9px] text-gray-300">-</span></div></div></div></div>
                <div><h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 pl-1">‰æùÂàÜÈ°û (By Category)</h4><div class="space-y-1"><div v-for="cat in expenseCategories" :key="cat" class="flex justify-between items-center py-1.5 px-2 border-b border-dashed border-gray-200 last:border-0"><div class="flex items-center gap-2"><i :class="getCategoryIcon(cat)" class="text-gray-300 text-[10px] w-4 text-center"></i><span class="text-[10px] font-bold text-gray-600">{{ cat }}</span></div><div class="flex gap-2 text-right"><span v-if="expenseStats.categories[cat].NZD > 0" class="text-[10px] font-bold text-dark">NZD {{ expenseStats.categories[cat].NZD.toLocaleString() }}</span><span v-if="expenseStats.categories[cat].TWD > 0" class="text-[10px] font-bold text-gray-400">TWD {{ expenseStats.categories[cat].TWD.toLocaleString() }}</span><span v-if="expenseStats.categories[cat].NZD === 0 && expenseStats.categories[cat].TWD === 0" class="text-[10px] text-gray-300">-</span></div></div></div></div>
                <button @click="showStatsModal=false" class="w-full mt-4 py-3 bg-primary text-white rounded-xl font-bold shadow-soft hover:bg-primary-dark transition-colors active:scale-95">ÈóúÈñâ</button>
            </div>
        </div>

        <div v-if="showSettingsModal" class="fixed inset-0 z-[10000] flex items-center justify-center bg-black/20 backdrop-blur-sm p-4">
            <div class="bg-white p-6 rounded-3xl w-72 shadow-2xl text-center relative max-h-[90vh] overflow-y-auto modal-scroll">
                <button @click="showSettingsModal=false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500 active:scale-90"><i class="fa-solid fa-xmark"></i></button>
                <h3 class="font-bold text-dark mb-4">Ë®≠ÂÆö</h3>
                
                <div class="mb-4 bg-gray-50 p-3 rounded-xl border border-cream-darker">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-gray-400 uppercase">Â≠óÈ´îÂ§ßÂ∞è</span>
                        <span class="text-[10px] font-bold text-dark">{{ currentFontSize }}px</span>
                    </div>
                    <div class="flex gap-2 justify-center">
                         <button @click="changeFontSize(-1)" class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-primary active:scale-90"><i class="fa-solid fa-minus text-xs"></i></button>
                         <button @click="changeFontSize(0)" class="px-3 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-[10px] text-gray-500 font-bold hover:text-primary active:scale-95">È†êË®≠</button>
                         <button @click="changeFontSize(1)" class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-primary active:scale-90"><i class="fa-solid fa-plus text-xs"></i></button>
                    </div>
                </div>

                <div class="mb-4 bg-cream p-3 rounded-xl border border-cream-darker">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-1 text-left">Èõ≤Á´ØÂêåÊ≠• ID</label>
                    <div class="flex gap-2"><input type="text" v-model="newTripId" placeholder="ID" class="flex-1 bg-white input-rounded p-1.5 text-xs font-bold text-dark outline-none border border-cream-darker"><button @click="changeTripId" class="bg-dark text-white px-2 py-1.5 rounded-lg text-[10px] font-bold hover:bg-gray-800 transition-colors whitespace-nowrap active:scale-95">ÂàáÊèõ</button></div>
                    <p class="text-[9px] text-gray-400 mt-1 text-left leading-relaxed">È†ªÈÅì: <span class="font-bold text-primary">{{ tripId }}</span></p>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2"><span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">‰∏ªÈ°åÈ¢®Ê†º</span><span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full font-bold truncate max-w-[80px]">{{ THEMES[currentTheme] ? THEMES[currentTheme].name : 'Ëá™Ë®Ç' }}</span></div>
                    <div class="grid grid-cols-3 gap-2">
                        <!-- Custom Theme Toggle -->
                        <button @click="applyTheme('custom')" class="relative p-2 rounded-xl border transition-all duration-200 flex flex-col items-center gap-1 group active:scale-95" :class="currentTheme === 'custom' ? 'border-primary bg-primary/5' : 'border-gray-100 hover:border-gray-200'">
                            <div class="w-6 h-6 rounded-full shadow-sm border border-white/50 flex items-center justify-center text-[8px] bg-gradient-to-br from-pink-200 to-blue-200 text-gray-500"><i class="fa-solid fa-palette"></i></div>
                            <span class="text-[10px] font-bold text-gray-500 group-hover:text-dark">Ëá™Ë®Ç</span>
                            <div v-if="currentTheme === 'custom'" class="absolute top-2 right-2 w-1.5 h-1.5 bg-primary rounded-full"></div>
                        </button>
                        <!-- Existing Themes -->
                        <button v-for="(t, key) in THEMES" :key="key" @click="applyTheme(key)" class="relative p-2 rounded-xl border transition-all duration-200 flex flex-col items-center gap-1 group active:scale-95" :class="currentTheme === key ? 'border-primary bg-primary/5' : 'border-gray-100 hover:border-gray-200'">
                            <div class="w-6 h-6 rounded-full shadow-sm border border-white/50 relative" :style="{backgroundColor: t.colors.primary}">
                                <div v-if="['oat'].includes(key)" class="absolute -top-1 -right-1 bg-red-500 text-white text-[6px] px-1 rounded-full animate-pulse border border-white">NEW</div>
                            </div>
                            <span class="text-[10px] font-bold text-gray-500 group-hover:text-dark truncate w-full text-center">{{ t.name }}</span>
                            <div v-if="currentTheme === key" class="absolute top-2 right-2 w-1.5 h-1.5 bg-primary rounded-full"></div>
                        </button>
                    </div>
                    
                    <!-- Custom Theme Editor (Only shows when Custom is active) -->
                    <div v-if="currentTheme === 'custom'" class="mt-3 bg-gray-50 p-3 rounded-xl border border-gray-200 animate-fade-in-down">
                        <h4 class="text-[10px] font-bold text-gray-400 mb-2 uppercase">Ëá™Ë®ÇË™øËâ≤Áõ§</h4>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between"><span class="text-xs font-bold text-gray-600">‰∏ªËâ≤ (Primary)</span><input type="color" v-model="customColors.primary" @input="updateCustomTheme" class="w-8 h-8 rounded-full overflow-hidden border-none cursor-pointer"></div>
                            <div class="flex items-center justify-between"><span class="text-xs font-bold text-gray-600">ËÉåÊôØËâ≤ (Bg)</span><input type="color" v-model="customColors.cream" @input="updateCustomTheme" class="w-8 h-8 rounded-full overflow-hidden border-none cursor-pointer"></div>
                            <div class="flex items-center justify-between"><span class="text-xs font-bold text-gray-600">ÊñáÂ≠óËâ≤ (Text)</span><input type="color" v-model="customColors.dark" @input="updateCustomTheme" class="w-8 h-8 rounded-full overflow-hidden border-none cursor-pointer"></div>
                        </div>
                    </div>
                </div>
                <!-- ... existing buttons ... -->
                <div class="space-y-3">
                    <div class="bg-gray-50 p-3 rounded-xl">
                        <div class="flex justify-between items-center mb-1"><span class="text-[10px] font-bold text-gray-400">ÂåØÁéá (NZD:TWD)</span><button @click="fetchRate" :disabled="isFetchingRate" class="text-[9px] bg-white border border-gray-200 px-2 py-0.5 rounded-full text-primary font-bold active:scale-90"><i class="fa-solid fa-rotate" :class="{'fa-spin': isFetchingRate}"></i></button></div>
                        <input type="number" v-model.number="exchangeRate" class="w-full bg-transparent text-center text-lg font-bold text-dark outline-none border-b border-gray-200 focus:border-primary pb-0.5">
                    </div>
                    <div class="grid grid-cols-2 gap-2"><button @click="saveToFile" class="py-2.5 bg-blue-50 text-blue-500 rounded-lg text-[10px] font-bold hover:bg-blue-100 active:scale-95">ÂÇô‰ªΩ</button><button @click="$refs.saveFileInput.click()" class="py-2.5 bg-orange-50 text-orange-500 rounded-lg text-[10px] font-bold hover:bg-orange-100 active:scale-95">ËÆÄÂèñ</button></div>
                    <div class="grid grid-cols-2 gap-2">
                        <button @click="exportExpensesCSV" class="w-full py-2.5 bg-green-50 text-green-600 rounded-lg text-[10px] font-bold hover:bg-green-100 transition-colors flex items-center justify-center gap-1 active:scale-95"><i class="fa-solid fa-file-csv"></i> ÂåØÂá∫Ë®òÂ∏≥</button>
                        <button @click="exportItineraryCSV" class="w-full py-2.5 bg-teal-50 text-teal-600 rounded-lg text-[10px] font-bold hover:bg-teal-100 transition-colors flex items-center justify-center gap-1 active:scale-95"><i class="fa-solid fa-file-csv"></i> ÂåØÂá∫Ë°åÁ®ã</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ... other modals ... -->
        <div v-if="showDaySettingsModal" class="fixed inset-0 z-[10000] flex items-center justify-center bg-black/20 backdrop-blur-sm p-4">
             <div class="bg-white p-6 rounded-3xl w-72 shadow-2xl relative">
                <button @click="showDaySettingsModal=false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500 active:scale-90"><i class="fa-solid fa-xmark"></i></button>
                <h3 class="font-bold text-dark mb-4 pl-1 text-sm">Day {{ selectedDayIndex }} Ë®≠ÂÆö</h3>
                <div class="space-y-3"><div><label class="text-[10px] font-bold text-gray-400 mb-0.5 block pl-1">Ê®ôÈ°å</label><input type="text" v-model="tempDaySettings.title" class="w-full bg-gray-50 input-rounded p-2 text-sm"></div><div><label class="text-[10px] font-bold text-gray-400 mb-0.5 block pl-1">Â§©Ê∞£Âú∞Èªû</label><div class="space-y-1.5"><div v-for="(slot, idx) in 3" :key="idx" class="relative"><input type="text" v-model="tempWeatherLocs[idx].name" :placeholder="`Âú∞Èªû ${idx + 1}`" @input="tempWeatherLocs[idx].lat = null; tempWeatherLocs[idx].lng = null" class="w-full bg-gray-50 input-rounded p-2 text-sm pr-6"><span v-if="tempWeatherLocs[idx].lat" class="absolute right-2 top-1/2 -translate-y-1/2 text-green-500 text-[10px]"><i class="fa-solid fa-check"></i></span></div></div></div></div>
                <button @click="saveDaySettings" class="w-full bg-primary text-white py-2.5 rounded-xl font-bold mt-5 shadow-lg shadow-primary/20 flex items-center justify-center gap-2 active:scale-95"><span v-if="isSavingSettings"><i class="fa-solid fa-circle-notch fa-spin"></i></span><span v-else>ÂÑ≤Â≠ò</span></button>
             </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        const hexToRgb = (hex) => { 
            const r = parseInt(hex.slice(1, 3), 16); 
            const g = parseInt(hex.slice(3, 5), 16); 
            const b = parseInt(hex.slice(5, 7), 16); 
            return `${r} ${g} ${b}`; 
        };
        
        // Helper to lighten/darken color for auto-generation
        const adjustColor = (hex, amount) => {
            return '#' + hex.replace(/^#/, '').replace(/../g, c => ('0' + Math.min(255, Math.max(0, parseInt(c, 16) + amount)).toString(16)).substr(-2));
        }

        const THEMES = { 
            oat: { name: 'ÁáïÈ∫•Â•∂Ëâ≤', colors: { primary: '#D3C6B8', primaryDark: '#A6998C', primaryLight: '#EBE4DC', cream: '#FDFBF8', creamDark: '#F2EEE8', creamDarker: '#E2D2C3', cardBg: '#FFFFFF', cardText: '#5D5650', dark: '#5D5650', darkSoft: '#787069', accent: '#D3C6B8' } }, // New Beige
            gogoro: { name: 'ÂéüËâ≤Ê£ï', colors: { primary: '#B5A89A', primaryDark: '#8C8073', primaryLight: '#E3DBD3', cream: '#F9F8F4', creamDark: '#EDEBE6', creamDarker: '#DBD8D0', cardBg: '#FFFFFF', cardText: '#2C241E', dark: '#2C241E', darkSoft: '#594A3E', accent: '#B5A89A' } },
            rose: { name: '‰πæÁá•Áé´Áë∞', colors: { primary: '#BC8F8F', primaryDark: '#8C5A5A', primaryLight: '#DCC3C3', cream: '#FDF8F8', creamDark: '#F5EBEB', creamDarker: '#E6D2D2', cardBg: '#E6D2D2', cardText: '#5E3C3C', dark: '#5E3C3C', darkSoft: '#785050', accent: '#BC8F8F' } },
            hojicha: { name: 'ÁÑôËå∂ÊãøÈêµ', colors: { primary: '#C89F81', primaryDark: '#A47E64', primaryLight: '#E6D2C3', cream: '#FFFCF5', creamDark: '#F5F0E6', creamDarker: '#EBE0D0', cardBg: '#F3E0C0', cardText: '#785A46', dark: '#54433A', darkSoft: '#8D7B72', accent: '#D4A373' } },
            mint: { name: 'ËñÑËç∑Â∑ßÂÖã', colors: { primary: '#80CBC4', primaryDark: '#00695C', primaryLight: '#B2DFDB', cream: '#F0FDFC', creamDark: '#E0F2F1', creamDarker: '#B2DFDB', cardBg: '#B2DFDB', cardText: '#004D40', dark: '#3E2723', darkSoft: '#4E342E', accent: '#009688' } },
            pudding: { name: 'Â∏É‰∏ÅÁãó', colors: { primary: '#784421', primaryDark: '#5D3518', primaryLight: '#A16A46', cream: '#FFF8D1', creamDark: '#FFF3B0', creamDarker: '#FFE082', cardBg: '#FFCA28', cardText: '#3E2723', dark: '#4E342E', darkSoft: '#6D4C41', accent: '#FFCA28' } },
            caramel: { name: 'ÁÑ¶Á≥ñÂ∏É‰∏Å', colors: { primary: '#EDB95E', primaryDark: '#D99836', primaryLight: '#FCEFCF', cream: '#FFFCF2', creamDark: '#FFF5E0', creamDarker: '#FFE0B2', cardBg: '#FFF3CD', cardText: '#5D4037', dark: '#5D4037', darkSoft: '#795548', accent: '#FFA000' } },
        };
        const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const selectedDayIndex = ref(0);
                const showItineraryModal = ref(false);
                const showExpenseModal = ref(false);
                const showSettingsModal = ref(false);
                const showStatsModal = ref(false); 
                const showDaySettingsModal = ref(false); 
                const isEditing = ref(false);
                const exchangeRate = ref(19.5);
                const connectionStatus = ref('connecting'); 
                const loadingMessage = ref('ÈÄ£Á∑ö‰∏≠...');
                const errorMessage = ref(''); 
                const isFetchingRate = ref(false);
                const isSearchingCoord = ref(false);
                const saveFileInput = ref(null);
                const dateContainer = ref(null);
                const isAllExpanded = ref(false); 
                // Set default to Oat
                const currentTheme = ref('oat'); 
                const isSavingSettings = ref(false);
                const currentFontSize = ref(16);
                
                // Custom Color State
                const customColors = ref({
                    primary: '#D3C6B8',
                    cream: '#FDFBF8',
                    dark: '#5D5650'
                });

                let storedId = localStorage.getItem('nz_trip_id');
                if (!storedId) { storedId = 'nz_' + Math.random().toString(36).substr(2, 6); localStorage.setItem('nz_trip_id', storedId); }
                const tripId = ref(storedId);
                const newTripId = ref('');
                let unsubscribeSnapshot = null;
                const hasPendingUploads = ref(false);

                const expandedItems = ref(new Set());
                const dailyWeatherList = ref([]);
                const dailyMetadata = ref({}); 
                const tempDaySettings = ref({ title: '' });
                const tempWeatherLocs = ref([{ name: '', lat: null, lng: null }, { name: '', lat: null, lng: null }, { name: '', lat: null, lng: null }]);
                
                const days = ref([]);
                const startDate = new Date('2026-01-17');
                for(let i=0; i<=15; i++) { const d = new Date(startDate); d.setDate(startDate.getDate() + i); days.value.push(d); }
                const getWeekDay = (d) => weekDays[d.getDay()];

                const itinerary = ref([]);
                const expenses = ref([]);
                const todos = ref([]);
                const todoCategory = ref('Ë°åÂâçÊ∫ñÂÇô');
                const newTodoText = ref('');
                const calcNZD = ref(0);
                const calcTWD = ref(0);
                const editingTodoId = ref(null);
                const tempTodoText = ref('');

                // NEW: Stamp Options
                const stamps = ['fa-heart', 'fa-star', 'fa-mug-hot', 'fa-camera', 'fa-plane', 'fa-face-laugh-beam', 'fa-paw', 'fa-music', 'fa-check'];
                
                // Helper to generate consistent but random-looking properties based on item ID
                const getPseudoRandom = (id, max) => (id % max);
                
                const getWashiTapeClass = (item) => {
                    const types = ['tape-pattern-dots', 'tape-pattern-stripes', 'tape-pattern-grid', '', '']; // empty string = solid color (opacity only)
                    const idx = getPseudoRandom(item.id, types.length);
                    return types[idx];
                }

                const getWashiTapeStyle = (item) => {
                    const rot = (item.id % 5) - 2; // -2 to 2 deg
                    const hueRotate = (item.id % 40) - 20; // Slight color variation
                    return {
                        transform: `translateX(-50%) rotate(${rot}deg)`,
                        filter: `hue-rotate(${hueRotate}deg)`
                    };
                }

                const getCardRotation = (index) => {
                    // Slight rotation for each card to look hand-placed
                    const deg = (index % 2 === 0) ? 0.5 : -0.5;
                    return { transform: `rotate(${deg}deg)` };
                }

                const getStampStyle = (item) => {
                    const rot = (item.id % 40) - 20; // -20 to 20 deg
                    const left = 75 + (item.id % 15); // 75% to 90%
                    const top = 10 + (item.id % 40); // 10% to 50%
                    return {
                        top: `${top}%`,
                        left: `${left}%`,
                        '--r': `${rot}deg`
                    };
                }

                const filteredItinerary = computed(() => itinerary.value.filter(i => i.day === selectedDayIndex.value).sort((a,b) => a.time.localeCompare(b.time)));
                const currentDayItems = computed(() => filteredItinerary.value); 
                const hasCoordinatesForDay = computed(() => filteredItinerary.value.some(i => i.lat && i.lng));
                
                const getDaySummary = computed(() => {
                    const meta = dailyMetadata.value[selectedDayIndex.value];
                    if (meta && meta.title) return meta.title;
                    const items = filteredItinerary.value;
                    if (items.length === 0) return 'Ëá™Áî±Ê¥ªÂãï';
                    const main = items.find(i => i.type !== '‰∫§ÈÄö') || items[0];
                    return main.location;
                });

                const totalNZD = computed(() => expenses.value.filter(e => e.currency === 'NZD').reduce((s, i) => s + i.amount, 0));
                const totalTWD = computed(() => expenses.value.filter(e => e.currency === 'TWD').reduce((s, i) => s + i.amount, 0));
                const grandTotalNZD = computed(() => totalNZD.value + (totalTWD.value / exchangeRate.value));
                const grandTotalTWD = computed(() => (totalNZD.value * exchangeRate.value) + totalTWD.value);
                
                const groupedExpenses = computed(() => {
                    const groups = {};
                    const sorted = [...expenses.value].sort((a, b) => new Date(b.date) - new Date(a.date));
                    sorted.forEach(item => {
                        const d = item.date;
                        if (!groups[d]) {
                            groups[d] = { items: [], total: 0 };
                        }
                        groups[d].items.push(item);
                        groups[d].total += (item.baseAmount || item.amount);
                    });
                    return groups;
                });
                
                const expenseStats = computed(() => {
                    const pStats = {};
                    const cStats = {};
                    payers.value.forEach(p => pStats[p] = { NZD: 0, TWD: 0 });
                    expenseCategories.forEach(c => cStats[c] = { NZD: 0, TWD: 0 });
                    expenses.value.forEach(e => {
                        const amt = Number(e.amount) || 0;
                        const curr = e.currency;
                        const payer = e.payer;
                        const cat = e.category;
                        if (pStats[payer]) pStats[payer][curr] += amt;
                        if (cStats[cat]) cStats[cat][curr] += amt;
                    });
                    return { payers: pStats, categories: cStats };
                });

                const filteredTodos = computed(() => {
                    return todos.value.filter(t => t.category === todoCategory.value).sort((a, b) => Number(a.done) - Number(b.done));
                });

                const form = ref({ id: null, dayIndex: 0, time: '09:00', type: 'ÊôØÈªû', title: '', location: '', address: '', lat: null, lng: null, notes: '', subItems: [], stamp: null });
                const expenseForm = ref({ amount: '', item: '', category: 'È§êÈ£≤', payer: 'Ant', currency: 'NZD', date: new Date().toISOString().split('T')[0] });
                const payers = ref(['Ant', 'Fish', 'ÂÖ¨Ë≤ª']);
                const expenseCategories = ['È§êÈ£≤', '‰∫§ÈÄö', '‰ΩèÂÆø', 'Ë≥ºÁâ©', 'Ê¥ªÂãï', 'ÂÖ∂‰ªñ'];
                
                let map = null;
                const formHour = computed({ get: () => form.value.time ? form.value.time.split(':')[0] : '09', set: (v) => { const m = form.value.time ? form.value.time.split(':')[1] : '00'; form.value.time = `${v}:${m}`; } });
                const formMinute = computed({ get: () => form.value.time ? form.value.time.split(':')[1] : '00', set: (v) => { const h = form.value.time ? form.value.time.split(':')[0] : '09'; form.value.time = `${h}:${v}`; } });

                const updateCustomTheme = () => {
                    const p = customColors.value.primary;
                    const b = customColors.value.cream;
                    const t = customColors.value.dark;
                    const r = document.documentElement;
                    
                    r.style.setProperty('--c-primary', hexToRgb(p));
                    r.style.setProperty('--c-primary-dark', hexToRgb(adjustColor(p, -40)));
                    r.style.setProperty('--c-primary-light', hexToRgb(adjustColor(p, 40)));
                    
                    r.style.setProperty('--c-cream', hexToRgb(b));
                    r.style.setProperty('--c-cream-dark', hexToRgb(adjustColor(b, -10)));
                    r.style.setProperty('--c-cream-darker', hexToRgb(adjustColor(b, -25)));
                    
                    r.style.setProperty('--c-card-bg', hexToRgb(adjustColor(b, -20)));
                    r.style.setProperty('--c-card-text', hexToRgb(t));
                    
                    r.style.setProperty('--c-dark', hexToRgb(t));
                    r.style.setProperty('--c-dark-soft', hexToRgb(adjustColor(t, 40)));
                    r.style.setProperty('--c-accent', hexToRgb(p));
                    
                    localStorage.setItem('nz_custom_theme', JSON.stringify(customColors.value));
                };

                const applyTheme = (key) => {
                    currentTheme.value = key;
                    localStorage.setItem('nz_theme_pref', key);
                    
                    if (key === 'custom') {
                        updateCustomTheme();
                        return;
                    }

                    const theme = THEMES[key]; 
                    if (!theme) return; 
                    
                    const r = document.documentElement; const c = theme.colors;
                    r.style.setProperty('--c-primary', hexToRgb(c.primary)); r.style.setProperty('--c-primary-dark', hexToRgb(c.primaryDark)); r.style.setProperty('--c-primary-light', hexToRgb(c.primaryLight));
                    r.style.setProperty('--c-cream', hexToRgb(c.cream)); r.style.setProperty('--c-cream-dark', hexToRgb(c.creamDark)); r.style.setProperty('--c-cream-darker', hexToRgb(c.creamDarker));
                    r.style.setProperty('--c-card-bg', hexToRgb(c.cardBg)); r.style.setProperty('--c-card-text', hexToRgb(c.cardText));
                    r.style.setProperty('--c-dark', hexToRgb(c.dark)); r.style.setProperty('--c-dark-soft', hexToRgb(c.darkSoft)); r.style.setProperty('--c-accent', hexToRgb(c.accent));
                };
                
                const formatDate = (dateObj) => (dateObj.getMonth()+1) + '/' + dateObj.getDate();
                const selectDate = (index) => selectedDayIndex.value = index;

                const getCategoryIcon = (c) => {
                    const map = {'È§êÈ£≤': 'fa-solid fa-utensils', '‰∫§ÈÄö': 'fa-solid fa-car', '‰ΩèÂÆø': 'fa-solid fa-bed', 'Ë≥ºÁâ©': 'fa-solid fa-bag-shopping', 'Ê¥ªÂãï': 'fa-solid fa-ticket', 'ÂÖ∂‰ªñ': 'fa-solid fa-ellipsis'};
                    return map[c] || 'fa-solid fa-circle-question';
                };

                const getTypeColorClass = (type) => {
                     const map = {
                         'ÊôØÈªû': 'bg-teal-50 text-teal-600 border-teal-100',
                         'ÁæéÈ£ü': 'bg-orange-50 text-orange-500 border-orange-100',
                         '‰ΩèÂÆø': 'bg-indigo-50 text-indigo-500 border-indigo-100',
                         '‰∫§ÈÄö': 'bg-gray-100 text-gray-500 border-gray-200',
                         'Ë≥ºÁâ©': 'bg-pink-50 text-pink-500 border-pink-100',
                         'Ê¥ªÂãï': 'bg-violet-50 text-violet-600 border-violet-100', // Added Activity Style
                         'ÂÖ∂‰ªñ': 'bg-gray-50 text-gray-500'
                     };
                     return map[type] || 'bg-gray-50 text-gray-500';
                };

                const changeFontSize = (delta) => {
                    if (delta === 0) currentFontSize.value = 16;
                    else currentFontSize.value = Math.max(12, Math.min(24, currentFontSize.value + delta));
                    document.documentElement.style.fontSize = currentFontSize.value + 'px';
                    localStorage.setItem('nz_font_size', currentFontSize.value);
                };

                const updateDailyWeather = async () => {
                    dailyWeatherList.value = [];
                    const dayMeta = dailyMetadata.value[selectedDayIndex.value] || {};
                    let targetLocs = dayMeta.weatherLocs || [];
                    if (targetLocs.length === 0) {
                         const dayItems = itinerary.value.filter(i => i.day === selectedDayIndex.value);
                         if (dayItems.length > 0 && dayItems[0].lat) targetLocs = [{ name: dayItems[0].location, lat: dayItems[0].lat, lng: dayItems[0].lng }];
                    }
                    const promises = targetLocs.filter(loc => loc.lat && loc.lng).map(async (loc) => {
                        try {
                            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lng}&current=temperature_2m,weather_code`);
                            const data = await res.json();
                            const code = data.current.weather_code;
                            let icon = 'fa-cloud'; 
                            if(code===0) icon='fa-sun'; else if(code>0 && code<4) icon='fa-cloud-sun'; else if(code>=51) icon='fa-cloud-rain';
                            return { temp: Math.round(data.current.temperature_2m), icon: 'fa-solid ' + icon, name: loc.name, lat: loc.lat, lng: loc.lng };
                        } catch (e) { return null; }
                    });
                    const results = await Promise.all(promises);
                    dailyWeatherList.value = results.filter(w => w !== null);
                }

                const loadLocalData = () => {
                    const s = localStorage.getItem('nz_data_v4');
                    if (s) { const d = JSON.parse(s); itinerary.value = d.itinerary||[]; expenses.value = d.expenses||[]; exchangeRate.value = d.exchangeRate||19.5; dailyMetadata.value = d.dailyMetadata||{}; todos.value = d.todos || []; }
                    updateDailyWeather();
                };

                const saveToLocal = () => {
                    const d = { itinerary: itinerary.value, expenses: expenses.value, exchangeRate: exchangeRate.value, dailyMetadata: dailyMetadata.value, todos: todos.value, lastUpdated: Date.now() };
                    localStorage.setItem('nz_data_v4', JSON.stringify(d));
                    if (connectionStatus.value === 'cloud') {
                        const { doc, setDoc } = window.firestoreMethods;
                        setDoc(doc(window.firestoreDB, "trips", tripId.value), d, { merge: true }).catch(e => { hasPendingUploads.value = true; });
                    } else hasPendingUploads.value = true;
                };

                const initSync = async () => {
                    // Try to load custom theme if exists
                    const savedCustom = localStorage.getItem('nz_custom_theme');
                    if(savedCustom) {
                        try { customColors.value = JSON.parse(savedCustom); } catch(e){}
                    }

                    // Try to load user pref first, otherwise default to Oat
                    const t = localStorage.getItem('nz_theme_pref'); 
                    if (t && (THEMES[t] || t === 'custom')) applyTheme(t); 
                    else applyTheme('oat'); // Set Oat as Default

                    const savedFont = localStorage.getItem('nz_font_size');
                    if(savedFont) currentFontSize.value = parseInt(savedFont);
                    else { const isDesktop = window.matchMedia("(pointer:fine)").matches; currentFontSize.value = isDesktop ? 17 : 16; }
                    document.documentElement.style.fontSize = currentFontSize.value + 'px';

                    loadLocalData();
                    let a = 0; while (!window.firestoreDB && a < 50) { await new Promise(r => setTimeout(r, 300)); a++; }
                    
                    if (window.firestoreDB && window.firebaseAuth) {
                        try {
                             const savedId = localStorage.getItem('nz_trip_id');
                             if(savedId && savedId !== tripId.value) tripId.value = savedId;
                             loadingMessage.value = 'ÁôªÂÖ•‰∏≠...';
                             if(!window.firebaseAuth.currentUser) await window.firestoreMethods.signInAnonymously(window.firebaseAuth);
                             loadingMessage.value = 'ÂêåÊ≠•‰∏≠...';
                             startSnapshotListener(); 
                        } catch (e) {
                             console.warn("Auth failed", e);
                             connectionStatus.value = 'error'; 
                             errorMessage.value = (e.code === 'auth/configuration-not-found' || e.code === 'auth/admin-restricted-operation') ? "auth_config_error" : e.message;
                        }
                    } else connectionStatus.value = 'local';
                    window.addEventListener('online', manualRetry);
                };
                
                const showErrorDetail = () => {
                    if(errorMessage.value === 'auth_config_error') alert('Ë´ãËá≥ Firebase Console ÈñãÂïüÂåøÂêçÁôªÂÖ•ÂäüËÉΩ„ÄÇ');
                    else if(errorMessage.value) alert(`ÈÄ£Á∑öÈåØË™§Ôºö${errorMessage.value}`);
                    else manualRetry();
                }

                const manualRetry = () => { connectionStatus.value = 'connecting'; loadingMessage.value = 'ÈáçÈÄ£‰∏≠...'; initSync(); };

                let retryCount = 0; let heartbeatInterval = null;
                const startSnapshotListener = () => {
                    connectionStatus.value = 'cloud'; 
                    const { doc, onSnapshot, setDoc } = window.firestoreMethods;
                    if(unsubscribeSnapshot) { unsubscribeSnapshot(); unsubscribeSnapshot = null; }
                    const ref = doc(window.firestoreDB, "trips", tripId.value);
                    
                    unsubscribeSnapshot = onSnapshot(ref, (snap) => {
                        retryCount = 0; 
                        if (snap.exists()) {
                            const cData = snap.data();
                            const lData = localStorage.getItem('nz_data_v4') ? JSON.parse(localStorage.getItem('nz_data_v4')) : {};
                            if ((lData.lastUpdated || 0) > (cData.lastUpdated || 0) + 5000) { setDoc(ref, lData, { merge: true }); return; }
                            
                            if (cData.itinerary) itinerary.value = cData.itinerary;
                            if (cData.expenses) { const m = new Map(); cData.expenses.forEach(e => m.set(e.id, e)); expenses.value.forEach(e => { if(!m.has(e.id)) m.set(e.id, e); }); expenses.value = Array.from(m.values()); }
                            if (cData.dailyMetadata) dailyMetadata.value = cData.dailyMetadata;
                            if (cData.exchangeRate) exchangeRate.value = cData.exchangeRate;
                            if (cData.todos) todos.value = cData.todos;
                            localStorage.setItem('nz_data_v4', JSON.stringify({ itinerary: itinerary.value, expenses: expenses.value, dailyMetadata: dailyMetadata.value, exchangeRate: exchangeRate.value, todos: todos.value, lastUpdated: cData.lastUpdated || 0 }));
                            updateDailyWeather();
                        } else {
                             const l = localStorage.getItem('nz_data_v4');
                             if(l) setDoc(ref, JSON.parse(l));
                             else { const init = { itinerary: [], expenses: [], exchangeRate: 19.5, dailyMetadata: {}, todos: [], lastUpdated: Date.now() }; setDoc(ref, init); localStorage.setItem('nz_data_v4', JSON.stringify(init)); loadLocalData(); }
                        }
                    }, (e) => { connectionStatus.value = 'error'; errorMessage.value = e.message; if (retryCount < 5) { retryCount++; setTimeout(startSnapshotListener, 3000); } });

                    if(!heartbeatInterval) heartbeatInterval = setInterval(() => { if(connectionStatus.value !== 'cloud' && navigator.onLine) manualRetry(); }, 5000);
                };

                const changeTripId = () => { 
                    if(newTripId.value && confirm(`Á¢∫ÂÆöÂàáÊèõÈ†ªÈÅìËá≥ "${newTripId.value}"Ôºü`)) { 
                        itinerary.value = []; expenses.value = []; dailyMetadata.value = {}; todos.value = []; localStorage.removeItem('nz_data_v4'); 
                        tripId.value = newTripId.value; localStorage.setItem('nz_trip_id', tripId.value); newTripId.value=''; startSnapshotListener(); 
                    }
                };
                const toggleGlobalFold = () => { isAllExpanded.value = !isAllExpanded.value; if (isAllExpanded.value) { const allIds = new Set(); filteredItinerary.value.forEach(i => allIds.add(i.id)); expandedItems.value = allIds; } else { expandedItems.value = new Set(); } };
                const toggleItem = (id) => { expandedItems.value.has(id) ? expandedItems.value.delete(id) : expandedItems.value.add(id); };
                const addSubItem = () => { if(!form.value.subItems) form.value.subItems = []; form.value.subItems.push({ location: '', lat: null, lng: null, notes: '' }); };
                const removeSubItem = (idx) => { form.value.subItems.splice(idx, 1); };

                const searchCoord = async (target) => {
                    if (!target.location) { alert('Ë´ãËº∏ÂÖ•Âú∞Èªû'); return; }
                    isSearchingCoord.value = true;
                    try {
                        const q = target.location.toLowerCase().includes('new zealand') ? target.location : `${target.location}, New Zealand`;
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
                        const d = await res.json();
                        if (d && d.length > 0) { target.lat = parseFloat(d[0].lat); target.lng = parseFloat(d[0].lon); } else alert('Êâæ‰∏çÂà∞Âú∞Èªû');
                    } catch (e) { console.error(e); alert('ÊêúÂ∞ãÂ§±Êïó'); } finally { isSearchingCoord.value = false; }
                };

                const initMap = () => {
                    if(map) { map.remove(); map=null; }
                    if(!document.getElementById('map-container')) return;
                    map = L.map('map-container', {zoomControl:false}).setView([-43.532, 172.636], 6);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {attribution:'&copy; OpenStreetMap'}).addTo(map);
                    const bounds = L.latLngBounds();
                    let hasPoints = false;
                    filteredItinerary.value.forEach(item => {
                        if(item.lat && item.lng) {
                            const icon = L.divIcon({className:'custom-div-icon', html:`<div class='marker-pin'></div><span class='marker-text'>${item.time}</span>`, iconSize:[30,42], iconAnchor:[15,42]});
                            const marker = L.marker([item.lat, item.lng], {icon}).addTo(map);
                            marker.bindPopup(`<div class='polaroid-popup'><div class='polaroid-title'>${item.title || item.location}</div><div class='polaroid-desc'>${item.notes || item.location}</div></div>`);
                            bounds.extend([item.lat, item.lng]); hasPoints=true;
                        }
                    });
                    locateUser();
                    if(hasPoints) { map.fitBounds(bounds, {padding:[50,50]}); }
                };

                const openModal = (type) => {
                     if(type==='itinerary') { 
                        isEditing.value=false; 
                        form.value={id:Date.now(), dayIndex:selectedDayIndex.value, time:'09:00', type:'ÊôØÈªû', location:'', address: '', lat: null, lng: null, notes:'', subItems:[], stamp: null}; 
                        showItineraryModal.value=true; 
                     }
                     else { const d=new Date(); const t=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; expenseForm.value={amount:'', item:'', category:'È§êÈ£≤', payer:'Ant', currency:'NZD', date:t}; showExpenseModal.value=true; }
                };
                const copyItem = (item) => { 
                    isEditing.value=false; 
                    form.value = { ...item, id: Date.now(), subItems: item.subItems ? [...item.subItems] : [] }; 
                    if(!form.value.time) form.value.time = '09:00';
                    showItineraryModal.value=true; 
                };
                const editItem = (item) => { 
                    isEditing.value=true; 
                    // Use spread syntax for safer copy, avoid JSON.stringify issues with proxies
                    form.value = { ...item, subItems: item.subItems ? [...item.subItems] : [] };
                    if(!form.value.time) form.value.time = '09:00';
                    form.value.dayIndex = item.day; 
                    showItineraryModal.value=true; 
                }; 
                const saveItinerary = () => {
                     let newItem = { ...form.value, day: form.value.dayIndex };
                     if(newItem.lat) newItem.lat = parseFloat(newItem.lat); if(newItem.lng) newItem.lng = parseFloat(newItem.lng);
                     if(newItem.subItems) newItem.subItems.forEach(s => { if(s.lat) s.lat=parseFloat(s.lat); if(s.lng) s.lng=parseFloat(s.lng); });
                     
                     if(isEditing.value) { 
                        const idx=itinerary.value.findIndex(i=>i.id===newItem.id); 
                        if(idx!==-1) itinerary.value.splice(idx, 1, newItem); // Use splice for reactivity
                     }
                     else itinerary.value.push(newItem);
                     saveToLocal(); closeModal(); updateDailyWeather();
                };

                const closeModal = () => { showItineraryModal.value=false; showExpenseModal.value=false; };
                const deleteItem = (id) => { if(confirm('Delete?')) { itinerary.value = itinerary.value.filter(i=>i.id!==id); saveToLocal(); }};
                const saveExpense = () => { if(!expenseForm.value.amount) return; const b = expenseForm.value.currency==='TWD'?expenseForm.value.amount/exchangeRate.value:expenseForm.value.amount; expenses.value.push({id:Date.now(), ...expenseForm.value, baseAmount:b, originalAmount:expenseForm.value.amount}); saveToLocal(); closeModal(); };
                const deleteExpense = (id) => { if(confirm('Delete?')) { expenses.value = expenses.value.filter(e=>e.id!==id); saveToLocal(); }};
                const navigateTo = (loc) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc + ', New Zealand')}`, '_blank');
                const locateUser = () => { if(navigator.geolocation && map) navigator.geolocation.getCurrentPosition(p=>{ map.setView([p.coords.latitude, p.coords.longitude], 14); if(window.userMarker) window.userMarker.setLatLng([p.coords.latitude, p.coords.longitude]); else window.userMarker = L.marker([p.coords.latitude, p.coords.longitude], {icon: L.divIcon({className:'custom-div-icon', html:`<div style="width:16px;height:16px;background:#3B82F6;border:3px solid white;border-radius:50%;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`})}).addTo(map); }); };

                const openDaySettings = () => {
                    const currentMeta = dailyMetadata.value[selectedDayIndex.value] || {};
                    tempDaySettings.value = { title: currentMeta.title || '' };
                    const existingLocs = currentMeta.weatherLocs || [];
                    tempWeatherLocs.value = [{ ...existingLocs[0] || { name: '', lat: null, lng: null } }, { ...existingLocs[1] || { name: '', lat: null, lng: null } }, { ...existingLocs[2] || { name: '', lat: null, lng: null } }];
                    showDaySettingsModal.value = true;
                }

                const saveDaySettings = async () => {
                    isSavingSettings.value = true;
                    for (let i = 0; i < 3; i++) {
                        const loc = tempWeatherLocs.value[i];
                        if (loc.name && !loc.lat) {
                            try {
                                const q = loc.name.toLowerCase().includes('new zealand') ? loc.name : `${loc.name}, New Zealand`;
                                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
                                const data = await res.json();
                                if (data && data.length > 0) { loc.lat = parseFloat(data[0].lat); loc.lng = parseFloat(data[0].lon); }
                            } catch (e) {}
                        }
                    }
                    if (!dailyMetadata.value[selectedDayIndex.value]) dailyMetadata.value[selectedDayIndex.value] = {};
                    dailyMetadata.value[selectedDayIndex.value].title = tempDaySettings.value.title;
                    dailyMetadata.value[selectedDayIndex.value].weatherLocs = tempWeatherLocs.value.filter(l => l.name);
                    saveToLocal(); await updateDailyWeather(); isSavingSettings.value = false; showDaySettingsModal.value = false;
                }

                const centerActiveDate = () => {
                    if (dateContainer.value && dateContainer.value.children[selectedDayIndex.value]) {
                        const activeBtn = dateContainer.value.children[selectedDayIndex.value];
                        dateContainer.value.scrollTo({ left: activeBtn.offsetLeft - (dateContainer.value.clientWidth / 2) + (activeBtn.clientWidth / 2), behavior: 'smooth' });
                    }
                }
                
                const fetchRate = async () => {
                    isFetchingRate.value = true;
                    try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/NZD'); const data = await res.json(); if (data?.rates?.TWD) { exchangeRate.value = parseFloat(data.rates.TWD.toFixed(2)); alert(`ÂåØÁéáÊõ¥Êñ∞: ${exchangeRate.value}`); } } catch (e) { alert('Êõ¥Êñ∞Â§±Êïó'); } finally { isFetchingRate.value = false; }
                };
                const saveToFile = () => {
                    const data = { itinerary: itinerary.value, expenses: expenses.value, exchangeRate: exchangeRate.value, dailyMetadata: dailyMetadata.value, savedAt: new Date().toLocaleString() };
                    const url = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: "application/json" }));
                    const a = document.createElement('a'); a.href = url; a.download = `nz_trip_save_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                };
                const exportExpensesCSV = () => {
                    if (expenses.value.length === 0) { alert('ÁõÆÂâçÊ≤íÊúâË®òÂ∏≥Ë≥áÊñôÂèØ‰ª•ÂåØÂá∫ÂñîÔºÅ'); return; }
                    const BOM = '\uFEFF'; let csvContent = BOM + "Êó•Êúü,È†ÖÁõÆ,ÂàÜÈ°û,‰ªòÊ¨æ‰∫∫,Âπ£Âà•,ÈáëÈ°ç,ÊèõÁÆóÁ¥êÂπ£(NZD)\n";
                    const sorted = [...expenses.value].sort((a, b) => new Date(b.date) - new Date(a.date));
                    sorted.forEach(e => {
                        const row = [e.date, `"${e.item.replace(/"/g, '""')}"`, e.category, e.payer, e.currency, e.amount, e.baseAmount.toFixed(2)].join(",");
                        csvContent += row + "\n";
                    });
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", `nz_expenses_export_${new Date().toISOString().slice(0,10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
                };
                
                const exportItineraryCSV = () => {
                    if (itinerary.value.length === 0) { alert('ÁõÆÂâçÊ≤íÊúâË°åÁ®ãË≥áÊñôÂèØ‰ª•ÂåØÂá∫ÂñîÔºÅ'); return; }
                    const BOM = '\uFEFF'; 
                    let csvContent = BOM + "Êó•Êúü,ÊôÇÈñì,È°ûÂà•,Ê®ôÈ°å/Âú∞Èªû,Ë©≥Á¥∞ÂÖßÂÆπ,ÂÇôË®ª,Á∑ØÂ∫¶,Á∂ìÂ∫¶\n";
                    
                    const getFullDate = (dayIndex) => {
                        const d = new Date(startDate); 
                        d.setDate(d.getDate() + dayIndex);
                        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                    };

                    const sorted = [...itinerary.value].sort((a, b) => {
                        if (a.day !== b.day) return a.day - b.day;
                        return a.time.localeCompare(b.time);
                    });

                    sorted.forEach(item => {
                        const dateStr = getFullDate(item.day);
                        let details = "";
                        if (item.subItems && item.subItems.length > 0) {
                            details = item.subItems.map(s => `[${s.location}] ${s.notes || ''}`).join("; ");
                        }
                        
                        const escape = (str) => str ? `"${str.toString().replace(/"/g, '""')}"` : "";

                        const row = [
                            dateStr,
                            item.time,
                            item.type,
                            escape(item.title || item.location),
                            escape(details),
                            escape(item.notes),
                            item.lat || "",
                            item.lng || ""
                        ].join(",");
                        csvContent += row + "\n";
                    });

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", `nz_itinerary_export_${new Date().toISOString().slice(0,10)}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                const loadFromFile = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (confirm(`ËÆÄÂèñÂ≠òÊ™îÔºü\nÊôÇÈñì: ${data.savedAt || 'Êú™Áü•'}`)) {
                                itinerary.value = data.itinerary || []; expenses.value = data.expenses || []; exchangeRate.value = data.exchangeRate || 19.5; dailyMetadata.value = data.dailyMetadata || {};
                                saveToLocal(); alert('ËÆÄÊ™îÊàêÂäüÔºÅ'); showSettingsModal.value = false; updateDailyWeather();
                            }
                        } catch (err) { alert('Ê™îÊ°àÊ†ºÂºèÈåØË™§'); }
                    };
                    reader.readAsText(file);
                    event.target.value = ''; 
                };

                watch(currentTab, (v) => { if(v==='map') nextTick(initMap); });
                watch(selectedDayIndex, () => { centerActiveDate(); updateDailyWeather(); if(currentTab.value==='map') initMap(); });
                onMounted(() => { 
                    const savedId = localStorage.getItem('nz_trip_id');
                    if(savedId) tripId.value = savedId;
                    initSync(); 
                    setTimeout(() => centerActiveDate(), 800); 
                });

                // Calculator logic
                const addNZD = (amount) => { calcNZD.value += amount; };
                watch(calcNZD, (newVal) => { calcTWD.value = parseFloat((newVal * exchangeRate.value).toFixed(2)); });
                watch(calcTWD, (newVal) => { calcNZD.value = parseFloat((newVal / exchangeRate.value).toFixed(2)); });

                // Todo logic
                const addTodo = () => {
                    if (!newTodoText.value.trim()) return;
                    todos.value.push({ id: Date.now(), text: newTodoText.value.trim(), done: false, category: todoCategory.value });
                    newTodoText.value = '';
                    saveToLocal();
                };
                const toggleTodo = (todo) => { todo.done = !todo.done; saveToLocal(); };
                const deleteTodo = (id) => { if(confirm('Âà™Èô§Ê≠§È†ÖÁõÆ?')) { todos.value = todos.value.filter(t => t.id !== id); saveToLocal(); } };
                
                // Todo Editing logic
                const startEditTodo = (todo) => {
                    editingTodoId.value = todo.id;
                    tempTodoText.value = todo.text;
                };
                
                const saveEditTodo = (todo) => {
                    if (!tempTodoText.value.trim()) return; // Prevent empty
                    todo.text = tempTodoText.value.trim();
                    editingTodoId.value = null;
                    saveToLocal();
                };
                
                const cancelEditTodo = () => {
                    editingTodoId.value = null;
                    tempTodoText.value = '';
                };

                return {
                    currentTab, selectedDayIndex, days, itinerary, expenses, filteredItinerary, groupedExpenses, connectionStatus, loadingMessage, errorMessage,
                    showItineraryModal, showExpenseModal, showSettingsModal, showDaySettingsModal, showStatsModal, isEditing, form, expenseForm, exchangeRate, isFetchingRate, saveFileInput, dateContainer,
                    dailyWeatherList, expandedItems, getDaySummary, toggleGlobalFold, toggleItem, isAllExpanded,
                    openModal, closeModal, saveItinerary, deleteItem, editItem, deleteExpense, saveExpense, fetchRate, saveToFile, loadFromFile, selectDate,
                    formatDate, getCategoryIcon, navigateTo, locateUser, formHour, formMinute, 
                    openDaySettings, tempDaySettings, saveDaySettings, currentDayItems, tempWeatherLocs, isSavingSettings,
                    searchCoord, isSearchingCoord, hasCoordinatesForDay, copyItem, addSubItem, removeSubItem,
                    payers, expenseCategories, getTypeColorClass,
                    totalNZD, totalTWD, grandTotalNZD, grandTotalTWD, expenseStats, exportExpensesCSV, exportItineraryCSV,
                    THEMES, currentTheme, applyTheme, getWeekDay,
                    tripId, newTripId, changeTripId, hasPendingUploads, initSync, manualRetry, showErrorDetail,
                    currentFontSize, changeFontSize,
                    todos, todoCategory, newTodoText, addTodo, toggleTodo, deleteTodo, filteredTodos,
                    calcNZD, calcTWD, addNZD,
                    editingTodoId, tempTodoText, startEditTodo, saveEditTodo, cancelEditTodo,
                    // New Diary Features
                    stamps, getWashiTapeClass, getWashiTapeStyle, getCardRotation, getStampStyle,
                    // V32 Custom Theme
                    customColors, updateCustomTheme
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
